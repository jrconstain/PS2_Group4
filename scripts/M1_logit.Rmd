---
title: "logit"
author: "G4"
date: "2025-10-12"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(pacman)

p_load(rio, # Import/export data.
       tidyverse, # Tidy-data.
       stargazer, # Descriptive statistics.
       gt, # Descriptive statistics.
       gtsummary,
       caret, # For predictive model assessment.
       gridExtra, # Arrange plots.
       skimr, # Summarize data.
       here, #for file searching
       readr, #for opening files
       ggplot2,
       boot,
       scales,
       car,
       dplyr,
       tidyr,
       plurrr
       )
```

```{r}
ruta1 <- here("stores", "train_hogares.csv")
df_train_hogares <- read_csv(ruta1)

ruta2 <- here("stores", "train_personas.csv")
df_train_personas <- read_csv(ruta2)

ruta3 <- here("stores", "test_personas.csv")
df_test_personas <- read_csv(ruta3)

ruta4 <- here("stores", "test_hogares.csv")
df_test_hogares <- read_csv(ruta4)
```

```{r}


set.seed(1011)

# variables a usar
vars <- c("P5000","P5010","P5090","P5100","P5130","P5140",
          "Nper","Npersug","Depto","Lp")

# Armar train/test
train_use <- df_train_hogares %>%
  select(Pobre, all_of(vars)) %>%
  mutate(Pobre = factor(Pobre, levels = c(0,1), labels = c("no_pobre","pobre")))

test_final <- df_test_hogares %>%
  select(all_of(vars))

# Convertir factores
if ("Depto" %in% vars) {
  train_use$Depto <- factor(train_use$Depto)
  test_final$Depto <- as.character(test_final$Depto)
}
if ("P5090" %in% vars) {
  train_use$P5090 <- factor(train_use$P5090)
  test_final$P5090 <- as.character(test_final$P5090)
}

# IMPUTACIÓN
# Numéricas: mediana del train
num_vars <- vars[!(vars %in% c("Depto","P5090"))]
for (v in num_vars) {
  med <- median(train_use[[v]], na.rm = TRUE)
  train_use[[v]][is.na(train_use[[v]])] <- med
  test_final[[v]][is.na(test_final[[v]])] <- med
}

# Categóricas: moda del train
if ("Depto" %in% vars) {
  mode_depto <- names(which.max(table(train_use$Depto)))
  train_use$Depto[is.na(train_use$Depto)] <- mode_depto
  test_depto <- test_final$Depto
  test_depto[is.na(test_depto) | !(test_depto %in% levels(train_use$Depto))] <- mode_depto
  test_final$Depto <- factor(test_depto, levels = levels(train_use$Depto))
}
if ("P5090" %in% vars) {
  mode_p5090 <- names(which.max(table(train_use$P5090)))
  train_use$P5090[is.na(train_use$P5090)] <- mode_p5090
  test_p5090 <- test_final$P5090
  test_p5090[is.na(test_p5090) | !(test_p5090 %in% levels(train_use$P5090))] <- mode_p5090
  test_final$P5090 <- factor(test_p5090, levels = levels(train_use$P5090))
}

# control y modelo
ctrl <- trainControl(method = "cv", number = 5, classProbs = TRUE, savePredictions = TRUE)
form <- as.formula(paste("Pobre ~", paste(vars, collapse = " + ")))

set.seed(1410)
modelo_logit <- train(
  form, data = train_use,
  method = "glm",
  family = "binomial",
  trControl = ctrl,
  na.action = na.omit
)

# predicción
pred_prob <- predict(modelo_logit, newdata = test_final, type = "prob")

# Umbral
th <- 0.5

# Predicción binaria 0/1 usando la prob. de "pobre"
prob_1 <- pred_prob[,"pobre"]
pred_01 <- as.integer(prob_1 >= th)

# Salida: id, probabilidad y predicción 0/1
id_out <- if ("id" %in% names(df_test_hogares)) df_test_hogares$id else seq_len(nrow(df_test_hogares))

predicciones_hogares <- tibble(
  id = id_out,
  prob_pobre_1 = prob_1,
  pobre_pred   = pred_01
)

# Formato Kaggle
kaggle_sub <- predicciones_hogares %>%
  transmute(
    id    = as.character(id),
    pobre = as.integer(pobre_pred)
  )

# Ponle un nombre siguiendo la convención
readr::write_csv(kaggle_sub, "LOGIT_treshold_05.csv")

head(kaggle_sub)
```

mean_edu_occ 
prop_occ_nper
prop_occ_pet
jefe_max_edu
prom_horas_occ

```{r}
# modelo 2

ruta5 <- here("stores", "train_hogares_enriquecido.csv")
train_hogares_enriquecido <- read_csv(ruta5)

ruta6 <- here("stores", "test_hogares_enriquecido.csv")
test_hogares_enriquecido <- read_csv(ruta6)

```

```{r}

set.seed(1011)

# var
vars <- c(
  "P5000","P5010","P5090","P5100","P5130","P5140",
  "Nper","Npersug","Depto","Lp",
  "mean_edu_occ","prop_occ_nper","prop_occ_pet","jefe_max_edu","prom_horas_occ"
)

# Armar train/test
train_use <- train_hogares_enriquecido %>%
  select(Pobre, all_of(vars)) %>%
  mutate(Pobre = factor(Pobre, levels = c(0,1), labels = c("no_pobre","pobre")))

test_final <- test_hogares_enriquecido %>%
  select(all_of(vars))

# solo Depto y P5090 son categóricas (además de Pobre)
cat_vars <- c("Depto","P5090")
num_vars <- setdiff(vars, cat_vars)

# Train: factores; Test: char para mapear y luego fijar niveles
train_use[cat_vars]  <- lapply(train_use[cat_vars],  factor)
test_final[cat_vars] <- lapply(test_final[cat_vars], as.character)

# IMPUTACIÓN (aprendida en TRAIN, aplicada a TRAIN y TEST)
# Numéricas -> mediana del TRAIN
for (v in num_vars) {
  med <- median(train_use[[v]], na.rm = TRUE)
  train_use[[v]][is.na(train_use[[v]])] <- med
  test_final[[v]][is.na(test_final[[v]])] <- med
}

# Categóricas
for (v in cat_vars) {
  mode_v <- names(which.max(table(train_use[[v]])))
  train_use[[v]][is.na(train_use[[v]])] <- mode_v
  tmp <- test_final[[v]]
  tmp[is.na(tmp) | !(tmp %in% levels(train_use[[v]]))] <- mode_v
  test_final[[v]] <- factor(tmp, levels = levels(train_use[[v]]))
}

# 4.3 Drop levels en TRAIN
train_use <- droplevels(train_use)

# 5) caret: control y modelo
ctrl <- trainControl(method = "cv", number = 5, classProbs = TRUE, savePredictions = TRUE)
form <- as.formula(paste("Pobre ~", paste(vars, collapse = " + ")))

set.seed(1410)
modelo_logit <- train(
  form, data = train_use,
  method = "glm",
  family = "binomial",
  trControl = ctrl,
  na.action = na.omit
)

# 6) Predicción en TEST (prob y clase 0/1 con th=0.5)
pred_prob <- predict(modelo_logit, newdata = test_final, type = "prob")
prob_1 <- pred_prob[,"pobre"]
pred_01 <- as.integer(prob_1 >= 0.5)

# 7) Salida con prob y pred
id_out <- if ("id" %in% names(test_hogares_enriquecido)) test_hogares_enriquecido$id else seq_len(nrow(test_hogares_enriquecido))

predicciones_hogares <- tibble(
  id = id_out,
  prob_pobre_1 = prob_1,
  pobre_pred   = pred_01
)

# 8) Formato Kaggle (solo id, pobre)
kaggle_sub <- predicciones_hogares %>%
  transmute(
    id    = as.character(id),
    pobre = as.integer(pobre_pred)
  )

write_csv(kaggle_sub,  here::here("stores", "LOGIT_th_050_V2.csv"))
```



Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.
